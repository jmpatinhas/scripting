// UiPath Invoke Code Activity
// Output variable: output (String)

// Add reference: Microsoft.Office.Interop.Outlook (via UiPath.Mail.Outlook.Activities)

DateTime startTime = DateTime.Now;
TimeSpan timeout = TimeSpan.FromMinutes(5);
bool outlookSynced = false;

try
{
    Microsoft.Office.Interop.Outlook.Application outlookApp = new Microsoft.Office.Interop.Outlook.Application();
    Microsoft.Office.Interop.Outlook.NameSpace outlookNs = outlookApp.GetNamespace("MAPI");

    // Inbox folder to monitor
    Microsoft.Office.Interop.Outlook.MAPIFolder inbox = outlookNs.GetDefaultFolder(
        Microsoft.Office.Interop.Outlook.OlDefaultFolders.olFolderInbox
    );

    int lastCount = inbox.Items.Count;
    DateTime stableSince = DateTime.Now;

    while (DateTime.Now - startTime < timeout)
    {
        int currentCount = inbox.Items.Count;

        if (currentCount == lastCount)
        {
            if ((DateTime.Now - stableSince).TotalSeconds > 10) // stable for 10s
            {
                outlookSynced = true;
                break;
            }
        }
        else
        {
            stableSince = DateTime.Now;
            lastCount = currentCount;
        }

        System.Threading.Thread.Sleep(2000);
    }
}
catch
{
    outlookSynced = false;
}

output = outlookSynced ? "True" : "False";
