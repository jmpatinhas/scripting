using System;
using System.Data;
using System.Linq;
using System.Text;
using System.Net;
using UiPath.CodedWorkflows; // depending on template, may be implicit

public class ConvertDtToHtmlTable : CodedWorkflow
{
    [Workflow]
    public string Execute(DataTable dtReport)
    {
        // Defensive checks
        if (dtReport == null)
            return "<div>(null DataTable)</div>";

        if (dtReport.Columns.Count == 0)
            return "<div>(DataTable has no columns)</div>";

        // Helper: HTML-encode and convert newlines to <br/>
        string EncodeCell(object cellObj)
        {
            if (cellObj == null || cellObj == DBNull.Value) return "";
            string s = cellObj.ToString();
            // Optionally truncate extremely long values here if desired:
            // if (s.Length > 1000) s = s.Substring(0, 1000) + "â€¦";
            // Encode then replace newlines with <br/>
            return WebUtility.HtmlEncode(s).Replace("\r\n", "<br/>").Replace("\n", "<br/>").Replace("\r", "<br/>");
        }

        var sb = new StringBuilder();

        // You can return just the <table> if you prefer; here I return a small wrapper.
        sb.AppendLine("<div style=\"font-family: monospace; font-size: 13px; color: #222;\">");
        sb.AppendLine("  <p style=\"margin:0 0 8px 0;\">Execution results:</p>");

        // Table with inline styles for email compatibility
        sb.AppendLine("  <table style=\"border-collapse: collapse; width: auto;\">");

        // Header row
        sb.AppendLine("    <thead>");
        sb.AppendLine("      <tr>");
        foreach (DataColumn col in dtReport.Columns)
        {
            string header = WebUtility.HtmlEncode(col.ColumnName ?? "");
            sb.AppendLine($"        <th style=\"border:1px solid #999; padding:6px 8px; text-align:left; background:#f2f2f2;\">{header}</th>");
        }
        sb.AppendLine("      </tr>");
        sb.AppendLine("    </thead>");

        // Body rows
        sb.AppendLine("    <tbody>");
        if (dtReport.Rows.Count == 0)
        {
            // Single row spanning all columns indicating no rows
            sb.AppendLine("      <tr>");
            sb.AppendLine($"        <td colspan=\"{dtReport.Columns.Count}\" style=\"border:1px solid #999; padding:6px 8px;\">(no rows)</td>");
            sb.AppendLine("      </tr>");
        }
        else
        {
            foreach (DataRow row in dtReport.Rows)
            {
                sb.AppendLine("      <tr>");
                foreach (DataColumn col in dtReport.Columns)
                {
                    string cellHtml = EncodeCell(row[col]);
                    sb.AppendLine($"        <td style=\"border:1px solid #999; padding:6px 8px; vertical-align:top;\">{cellHtml}</td>");
                }
                sb.AppendLine("      </tr>");
            }
        }
        sb.AppendLine("    </tbody>");

        sb.AppendLine("  </table>");
        sb.AppendLine("</div>");

        return sb.ToString();
    }
}
